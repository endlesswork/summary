è¿™é‡Œæˆ‘ä»¬çœ‹ä¸ªä¾‹å­ï¼Œå‡è®¾æˆ‘ä»¬æœ‰å¦‚ä¸‹ä»£ç 
```java
@Slf4j
@RestController
@RequestMapping("/lock")
public class RedisLockDemo {

    @Resource
    private RedissonClient redissonClient;

    @PostMapping("/user")
    public void lockUser(@RequestParam String name) {
        RLock lock = redissonClient.getLock("myLock");
        log.info("{} å¼€å§‹èŽ·å–é”, time: {}", name, System.currentTimeMillis());
        try {
            // å°è¯•èŽ·å–é”ï¼Œæœ€å¤šç­‰å¾…5ç§’ï¼Œé”è‡ªåŠ¨é‡Šæ”¾æ—¶é—´æ˜¯10ç§’
            if (lock.tryLock(5, 10, TimeUnit.SECONDS)) {
                try {
                    log.info("{} æˆåŠŸèŽ·å–é”, time: {}", name, System.currentTimeMillis());
                    // æ¨¡æ‹Ÿä¸šåŠ¡é€»è¾‘
                    Thread.sleep(7000);
                } finally {
                    lock.unlock();
                    log.info("{} é‡Šæ”¾é”, time: {}", name,  System.currentTimeMillis());
                }
            } else {
                log.info("{} èŽ·å–é”å¤±è´¥, time: {}", name, System.currentTimeMillis());
            }
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
            log.error("{} èŽ·å–é”å¼‚å¸¸", name, e);
        }
    }

}
```
å¦‚æžœæœ‰2ä¸ªè¯·æ±‚ aå’Œb åŒæ—¶è¿‡æ¥ï¼Œ a æŠ¢åˆ°é”

æ­£å¸¸åº”è¯¥è¾“å‡ºå¦‚ä¸‹
```
 a å¼€å§‹èŽ·å–é”, time: 1746289475348
 a æˆåŠŸèŽ·å–é”, time: 1746289475365
 b å¼€å§‹èŽ·å–é”, time: 1746289477146
 b èŽ·å–é”å¤±è´¥, time: 1746289482160
 a é‡Šæ”¾é”,     time: 1746289482377

```
å¯ä»¥çœ‹åˆ° b åœ¨ç­‰å¾…äº†å¤§æ¦‚ 1746289482160- 1746289477146 = 5014 msåŽä¼šæ‰“å°èŽ·å–é”å¤±è´¥

## ðŸ¤” å¦‚æžœ Thread.sleep çš„æ—¶é—´å¤§äºŽ10s

æˆ‘ä»¬å°†ä»£ç ä¿®æ”¹å¦‚ä¸‹
```java 
// æ¨¡æ‹Ÿä¸šåŠ¡é€»è¾‘
 Thread.sleep(12000);

```

å¦‚æžœåœ¨æˆ‘ä»¬ä¸ä¿®æ”¹ä»£ç çš„æƒ…å†µä¸‹ï¼Œè¾“å‡ºå¦‚ä¸‹ï¼Œä¹‹æ‰€ä»¥è¿™æ ·æ˜¯ å®žé™…ä¸šåŠ¡æ¯”redisåˆšå¼€å§‹è®¾ç½®åˆ†å¸ƒå¼é”åŠ é”æ—¶é—´è¦é•¿ï¼Œåˆ†å¸ƒå¼é”æ²¡æœ‰ç»­æœŸ

```
 a å¼€å§‹èŽ·å–é”, time: 1746290925414
 a æˆåŠŸèŽ·å–é”, time: 1746290925429
 b å¼€å§‹èŽ·å–é”, time: 1746290926974
 b èŽ·å–é”å¤±è´¥, time: 1746290931990
 java.lang.IllegalMonitorStateException: attempt to unlock lock, not locked by current thread by node id:705016b6-6daf-4292-9776-7e12990bed44 thread-id: 96
```
### ðŸŸ¢ **ä¼šå¼€å¯çœ‹é—¨ç‹—çš„æƒ…å†µï¼ˆè‡ªåŠ¨ç»­æœŸï¼‰**

| æ–¹æ³•è°ƒç”¨                                 | æ˜¯å¦å¼€å¯ | åŽŸå› è¯´æ˜Ž |
|------------------------------------------|----------|-----------|
| `lock()`                                  | âœ… æ˜¯     | æ²¡æŒ‡å®šè¿‡æœŸæ—¶é—´ï¼Œä½¿ç”¨é»˜è®¤ 30 ç§’å¹¶è‡ªåŠ¨ç»­æœŸ |
| `tryLock()`                               | âœ… æ˜¯     | æ— å‚æ•°ç‰ˆæœ¬ï¼Œé»˜è®¤ä½¿ç”¨ 30 ç§’å¹¶è‡ªåŠ¨ç»­æœŸ |
| `tryLock(waitTime, unit)`                 | âœ… æ˜¯     | åªè®¾ç½®äº†ç­‰å¾…æ—¶é—´ï¼Œæœªè®¾ç½®æŒé”æ—¶é—´ |
| `lockInterruptibly()`                     | âœ… æ˜¯     | æ²¡æœ‰è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œé»˜è®¤ç»­æœŸ |

- ðŸ” **ç»­æœŸé¢‘çŽ‡**ï¼šæ¯ 10 ç§’ï¼›
- ðŸ•’ **é”é»˜è®¤è¿‡æœŸæ—¶é—´**ï¼š30 ç§’ï¼›
- ðŸ§µ **æ¡ä»¶**ï¼šä»…å½“æœªæ˜¾å¼æŒ‡å®š `leaseTime`ã€‚

---

### ðŸ”´ **ä¸ä¼šå¼€å¯çœ‹é—¨ç‹—çš„æƒ…å†µï¼ˆä¸è‡ªåŠ¨ç»­æœŸï¼‰**

| æ–¹æ³•è°ƒç”¨                                           | æ˜¯å¦å¼€å¯ | åŽŸå› è¯´æ˜Ž |
|----------------------------------------------------|----------|-----------|
| `lock(leaseTime, unit)`                            | âŒ å¦     | æ˜¾å¼è®¾ç½®äº†è¿‡æœŸæ—¶é—´ |
| `tryLock(waitTime, leaseTime, unit)`               | âŒ å¦     | æ˜¾å¼è®¾ç½®äº†æŒé”æ—¶é—´ |
| `tryLock(leaseTime, unit)`ï¼ˆæŸäº›é‡è½½ï¼‰             | âŒ å¦     | æ˜¾å¼æŒ‡å®šäº† leaseTime |

- â±ï¸ **é”åœ¨ leaseTime åŽè‡ªåŠ¨é‡Šæ”¾**ï¼›
- ðŸ”’ **ä¸ä¼šç»­æœŸ**ï¼Œé€‚åˆä¸šåŠ¡æ‰§è¡Œæ—¶é—´æ˜Žç¡®çš„åœºæ™¯ã€‚


## âš™ï¸ æˆ‘ä»¬çœ‹ä¸‹ å¼€å¯çœ‹é—¨ç‹—æƒ…å†µä¸‹ Redisson åˆ†å¸ƒé”çš„åŠ é”è¿‡ç¨‹

### ðŸ”‘ 1. åŠ é”åŽŸç†

åŠ é”æ—¶çš„ Lua è„šæœ¬é€»è¾‘ï¼š
- Redis key çš„ç»“æž„ä¸ºï¼šmyLockï¼Œvalue æ˜¯ä¸€ä¸ª JSON å­—ç¬¦ä¸²ï¼Œè®°å½•äº† UUID + çº¿ç¨‹ID å’Œ é‡å…¥æ¬¡æ•°ã€‚
- ä½¿ç”¨ SETNX å®žçŽ°é”çš„åŽŸå­åŠ é”ï¼Œå¦‚æžœ key ä¸å­˜åœ¨ï¼Œåˆ™è®¾ç½®æˆåŠŸï¼Œé”è¢«èŽ·å–ã€‚
- å¦‚æžœé”å·²å­˜åœ¨ï¼Œå¹¶ä¸”æ˜¯ å½“å‰çº¿ç¨‹åŠ çš„é”ï¼Œåˆ™è¡¨ç¤ºæ˜¯é‡å…¥ï¼Œç›´æŽ¥å°†é‡å…¥æ¬¡æ•°åŠ  1ã€‚
- å¦‚æžœæ˜¯å…¶ä»–çº¿ç¨‹æŒæœ‰é”ï¼Œåˆ™å½“å‰çº¿ç¨‹è¿›å…¥ç­‰å¾…ã€‚
ç¤ºä¾‹ Lua è„šæœ¬é€»è¾‘ï¼š
```lua
if (redis.call('exists', KEYS[1]) == 0) then
  redis.call('hset', KEYS[1], ARGV[2], 1)
  redis.call('pexpire', KEYS[1], ARGV[1])
  return nil
end
```
- KEYS[1] æ˜¯é”å
- ARGV[1] æ˜¯è¿‡æœŸæ—¶é—´ï¼ˆé»˜è®¤ 30sï¼‰
- ARGV[2] æ˜¯çº¿ç¨‹æ ‡è¯†ï¼ˆUUID + çº¿ç¨‹ IDï¼‰

### ðŸ” 2. è‡ªåŠ¨ç»­æœŸæœºåˆ¶

- åŠ é”æˆåŠŸåŽï¼ŒRedisson ä¼šä¸ºè¯¥é”å¼€å¯ä¸€ä¸ª â€œçœ‹é—¨ç‹—å®šæ—¶ä»»åŠ¡â€ï¼›
- æ¯éš” 10 ç§’ï¼ŒRedisson ä¼šæ£€æŸ¥è¯¥çº¿ç¨‹æ˜¯å¦è¿˜æŒæœ‰é”ï¼ˆåˆ¤æ–­çš„ä¾æ®æ˜¯å®šæ—¶æ£€æŸ¥è¿™ä¸ªåˆ†å¸ƒå¼é”key æ˜¯å¦è¿˜å­˜åœ¨ï¼Œå­˜åœ¨åˆ™ç»™å®ƒç»­çº¦ï¼‰ï¼›
- å¦‚æžœè¿˜æŒæœ‰ï¼Œå°±å‘é€ä¸€ä¸ª Lua è„šæœ¬ï¼Œå°†é”çš„è¿‡æœŸæ—¶é—´å»¶é•¿å›ž 30 ç§’ï¼›
- å¦‚æžœé”å·²ç»é‡Šæ”¾æˆ–è€…çº¿ç¨‹å…³é—­ï¼Œè¯¥å®šæ—¶ä»»åŠ¡å°±ä¼šè‡ªåŠ¨åœæ­¢

ðŸ”§ å®žçŽ°æ–¹å¼ï¼ˆLua è„šæœ¬æ ¸å¿ƒç»­æœŸï¼‰
```lua
if (redis.call("hexists", KEYS[1], ARGV[1]) == 1) then
  redis.call("pexpire", KEYS[1], ARGV[2])
  return 1
end
return 0
```
- KEYS[1] æ˜¯é”çš„ Redis keyï¼›

- ARGV[1] æ˜¯å½“å‰çº¿ç¨‹çš„æ ‡è¯†ï¼ˆUUID + ThreadIdï¼‰ï¼›

- ARGV[2] æ˜¯æ–°çš„è¿‡æœŸæ—¶é—´ï¼ˆ30 ç§’ï¼‰ï¼›

è¯¥è„šæœ¬ä¼šåˆ¤æ–­ï¼šå½“å‰çº¿ç¨‹æ˜¯å¦ä»ç„¶æŒæœ‰é”ï¼Œå¦‚æžœæ˜¯ï¼Œå°±é‡æ–°è®¾ç½®é”çš„è¿‡æœŸæ—¶é—´

### ðŸ”“ 3. è§£é”åŽŸç†
è§£é”æ—¶ä¼šåˆ¤æ–­ï¼š

- å½“å‰çº¿ç¨‹æ˜¯å¦æ˜¯é”çš„æŒæœ‰è€…ï¼ˆé€šè¿‡æ¯”è¾ƒçº¿ç¨‹å”¯ä¸€æ ‡è¯† UUID + çº¿ç¨‹ IDï¼‰ã€‚

- æ˜¯çš„è¯å°±å‡å°‘é‡å…¥æ¬¡æ•°ï¼Œå¦‚æžœæ¬¡æ•°ä¸º 0ï¼Œå°±åˆ é™¤è¿™ä¸ª keyã€‚

- ä¸æ˜¯å½“å‰çº¿ç¨‹çš„é”ï¼Œåˆ™æŠ›å‡º IllegalMonitorStateException å¼‚å¸¸ã€‚

åŒæ ·é€šè¿‡ Lua è„šæœ¬ä¿è¯è§£é”çš„åŽŸå­æ€§ï¼š
```lua
if (redis.call('hexists', KEYS[1], ARGV[1]) == 0) then
  return nil
end

local counter = redis.call('hincrby', KEYS[1], ARGV[1], -1)
if (counter > 0) then
  redis.call('pexpire', KEYS[1], ARGV[2])
  return 0
else
  redis.call('del', KEYS[1])
  return 1
end

```

