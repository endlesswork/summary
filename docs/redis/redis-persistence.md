## redis持久化方式

在Redis中存在2种持久化机制
### 一、RDB

1、RDB既可以手动执行，也可以通过服务器配置定期执行。
在Redis中有2个命令可以生成RDB文件，SAVE和BGSAVE,SAVE命令会阻塞进行，BGSAVE则会fork出一个子进程，由这个子进程进行生成RDB文件。
我们可以通过配置来改变服务器定期自动生成RDB文件，配置格式如下
```
save 900  1
save 300  10
save 60   10000
```
只要满足三个情况里面任意一种，比如第一行代表900秒内对服务器进行至少一次的修改，第二行代表300秒内对服务器进行至少10次修改，第三行代表60秒内对服务器进行至少10000次修改。当满足这三种任意一种情况，redis就会通过BGSAVE去生成RDB文件。
同样我们可以再redis.conf中找到关于save的配置
```
#   save ""

save 900 1
save 300 10
save 60 10000
```
在上面我们提到了我们需要去满足三种情况中任意一种就进行BGSAVE去生成RDB文件。那么Redis中是如何判断是否满足条件呢？
在Redis中会保存一个计数器dirty和一个上次SAVE保存执行的时间lastsave，当我们对于数据进行修改操作时候，会对这个计数器dirty进行+1操作。
在redis中，周期性函数serverCron会每隔100毫秒对比当前时间戳和计数器
，检查当前状态是否满足执行BGSAVE条件。如果满足则执行BGSAVE，并且对dirty进行归0操作，将lastsave时间更新为此次BGSAVE执行完成时间。

RDB持久化是指在指定的时间间隔内将内存中的数据集快照写入磁盘，实际操作过程是fork一个子进程，先将数据集写入临时文件，写入成功后，再替换之前的文件，用二进制压缩存储。
RDB是Redis默认的持久化方式，会在对应的目录下生产一个dump.rdb文件，重启会通过加载dump.rdb文件恢复数据。

![rdb](/image/redis/rdb.png)

2、优点

1）只有一个文件dump.rdb，方便持久化；

2） 容灾性好，一个文件可以保存到安全的磁盘；

3） 性能最大化，fork子进程来完成写操作，让主进程继续处理命令，所以是IO最大化（使用单独子进程来进行持久化，主进程不会进行任何IO操作，保证了redis的高性能) ；

4）如果数据集偏大，RDB的启动效率会比AOF更高。

3、缺点

1）数据安全性低。（RDB是间隔一段时间进行持久化，如果持久化之间redis发生故障，会发生数据丢失。所以这种方式更适合数据要求不是特别严格的时候）

2）由于RDB是通过fork子进程来协助完成数据持久化工作的，因此，如果当数据集较大时，可能会导致整个服务器停止服务几百毫秒，甚至是1秒钟。
 

 ### 二、AOF
AOF是以日志的形式记录下服务器处理的每一个写、删除操作,
AOF持久化的实现是分为命令追加（append）、文件写入、文件同步（sync）三个过程
#### 1、命令追加
在redis服务器开启AOF情况下，redis.conf配置如下（默认no，关闭）
```
# Please check http://redis.io/topics/persistence for more information.
appendonly yes
```
服务器每执行完一个写或删除操作时，会将执行的命令追加到服务器状态的aof_buf（sds格式，redis自己构建的简单动态字符串）缓冲区的末尾。
```
# appendfsync always
appendfsync everysec
# appendfsync no
```
1、AOF持久化是以日志的形式记录服务器所处理的每一个写、删除操作，查询操作不会记录，以文本的方式记录，文件中可以看到详细的操作记录。她的出现是为了弥补RDB的不足（数据的不一致性），所以它采用日志的形式来记录每个写操作，并追加到文件中。Redis 重启的会根据日志文件的内容将写指令从前到后执行一次以完成数据的恢复工作。
![[redis-trib.png]]


2、优点

1）数据安全性更高，AOF持久化可以配置appendfsync属性，其中always，每进行一次命令操作就记录到AOF文件中一次。

2）通过append模式写文件，即使中途服务器宕机，可以通过redis-check-aof工具解决数据一致性问题。

3）AOF机制的rewrite模式。(AOF文件没被rewrite之前（文件过大时会对命令进行合并重写），可以删除其中的某些命令（比如误操作的flushall）)

3、缺点

1）AOF文件比RDB文件大，且恢复速度慢；数据集大的时候，比rdb启动效率低。

2）根据同步策略的不同，AOF在运行效率上往往会慢于RDB。

