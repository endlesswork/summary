在一些日常使用中 比如我们要统计

网站统计UV（独立访客数）

活动参与人数（每天来多少新用户）

大规模日志，统计不同IP数

重点是：我们关心的是数量 而不是具体比如 活动是张三参加还是李四参加，我们只希望统计总的数量，
除了 使用BiteMap外 我们还可以使用  HyperLogLog

HyperLogLog最大特点

1. 超省内存 （无论加多少元素，最多用12KB内存，适合大批量数据）
2. 它的统计数量是估算值 （有1%左右的误差）

#### 为什么它拥有这些特点

HyperLogLog 的计算过程如下

1. 元素哈希	把元素（比如"a"）哈希成一个 64位二进制串。
2. 选桶	取哈希值的前14位（高位），这14位决定落到哪个桶（$2^{64}$ = 16384个桶）。
3. 计算前导0	看哈希值剩下的50位（低位），计算从左到右连续出现的0的个数。
4. 更新桶	如果当前桶里记录的"最大前导0数量"小于新算出来的数量，则更新桶里的值。
5. 汇总估算	遍历所有桶，根据每个桶的最大前导0数量，应用数学公式（调和平均、偏差校正等），估算出去重后的总数量。

---

#### 概念
##### 哈希空间

哈希空间就是**所有可能哈希值组成的集合**。

比如：
- 如果哈希函数输出 64 位，那么所有可能的哈希值数量是 $2^{64}$。
- 64 位哈希空间的大小是 $2^{64}$。

每一个元素经过哈希以后，会**随机均匀地分布到这个巨大的空间里的一点**。

---

##### 稀疏性

**稀疏性**的意思是：

- **空间很大，但实际用到的位置很少**。
- **元素之间分布得很稀，很分散**。

举例：
- 哈希空间大小是 $2^{64}$。
- 实际哈希的元素只有 $10^7$ 个。
- 绝大部分哈希位置是空的。

这种 "元素少、空间大" 的情况，就叫做**哈希空间稀疏**。

哈希空间稀疏很重要

- 元素数量少 → 哈希值到处是空的 → 很稀疏。
- 通过观察稀疏程度（比如最大前导0数量）可以**估算元素总量**。
- 元素数量多 → 哈希值很密集 → 稀疏性降低 → 需要进行补偿或校正。

**HyperLogLog** 正是利用了哈希空间稀疏性的特点！

---

#### 前导0

在 HyperLogLog 内部 有 $2^{14}$ = 16384 个桶，

比如 我们有元素a、b、c 

元素 | 哈希前14位| 桶编号| 后50位 | 前导0个数
---|---|---|---|---
a | 0000 0000 0011 00 | 12|0000 01xx ....| 5
b | 0000 0000 0011 00 | 12|0000 001x ....| 6
b | 0000 0000 0011 10 | 14|0000 01xx ....| 5

则此时 桶12的的最大前导0数量为6 ， 桶12的的最大前导0数量为5

前导0数量反映了哈希空间的稀疏程度。

- **前导0多**（比如 20个）：
  - 哈希值很小，落在 $2^{-20}$ 这么小的范围。
  - 空间非常稀疏。
- **前导0少**（比如 2个）：
  - 哈希值大，元素密集得多。

因此：

- 前导0数量越大 → 空间越稀疏 → 元素总量越大。
- 前导0数量越小 → 空间较密集 → 元素总量较小。



