InnoDB å­˜å‚¨å¼•æ“Žä¸ºäº†å®žçŽ°é«˜å¹¶å‘äº‹åŠ¡å¤„ç†ï¼Œé‡‡ç”¨äº†å¤šç§é”æœºåˆ¶ï¼ŒåŒ…æ‹¬è¡Œé”ã€é—´éš™é”ã€æ„å‘é”ã€è¡¨é”ã€å…ƒæ•°æ®é”ç­‰ã€‚

## ðŸ”’ 1. è¡Œé”ï¼ˆRecord Lockï¼‰

- **å®šä¹‰**ï¼šé”å®šæŸä¸€æ¡å·²å­˜åœ¨çš„è®°å½•ã€‚
- **è§¦å‘æ¡ä»¶**ï¼š
  - ç²¾ç¡®åŒ¹é…ç´¢å¼•åˆ—çš„ DML/SELECT FOR UPDATE è¯­å¥ã€‚
- **ç¤ºä¾‹**ï¼š

```sql
SELECT * FROM users WHERE id = 5 FOR UPDATE;
UPDATE users SET name = 'aaa' WHERE id = 5;
```
- è¯´æ˜Žï¼šå…¶ä»–äº‹åŠ¡ä¸èƒ½ä¿®æ”¹è¿™æ¡è®°å½•ï¼Œç›´åˆ°å½“å‰äº‹åŠ¡æäº¤æˆ–å›žæ»šã€‚

## ðŸ”’ 2. é—´éš™é”ï¼ˆGap Lockï¼‰
- **å®šä¹‰**ï¼šé”å®šä¸¤æ¡ç´¢å¼•è®°å½•ä¹‹é—´çš„é—´éš™ï¼Œä¸ºäº†é˜²æ­¢å¹»è¯»è€Œå¼•å…¥çš„é”ã€‚å®ƒé”ä½çš„æ˜¯ **ç´¢å¼•è®°å½•ä¹‹é—´çš„é—´éš™**ï¼Œå¹¶ä¸ä¼šé”å®šå…·ä½“çš„è®°å½•ã€‚
- **è§¦å‘æ¡ä»¶**ï¼š
	- äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸º REPEATABLE READã€‚
	- ä½¿ç”¨èŒƒå›´æŸ¥è¯¢ä¸”å¸¦ç´¢å¼•ï¼ˆä¸æ˜¯ä¸»é”®ç­‰å€¼ï¼‰ã€‚
	- è¯­å¥ä¸º SELECT ... FOR UPDATEã€UPDATE ç­‰ã€‚

- **ç¤ºä¾‹**ï¼š
```sql
SELECT * FROM users WHERE id > 5 AND id < 10 FOR UPDATE;
DELETE FROM users WHERE id > 5 AND id < 10;
```
- è¯´æ˜Žï¼šå¦‚æžœ id æ˜¯ä¸»é”®æˆ–æœ‰ç´¢å¼•ï¼Œä¼šé”ä½ id åœ¨ (5,10) ä¹‹é—´çš„ç©ºéš™ï¼Œé˜²æ­¢æ’å…¥ id=6ã€7ã€8ã€9 ç­‰è®°å½•ã€‚å¦‚æžœid<5å¹¶ä¸å­˜åœ¨è®°å½•ï¼Œåˆ™é”ä½(-âˆž,10)
**ä¼šå‘å‰â€œæ‰©å±•â€åˆ°å‰ä¸€æ¡è®°å½•ï¼Œå¦‚æžœæ²¡æœ‰ï¼Œå°±é”åˆ°è´Ÿæ— ç©·ï¼ˆ-âˆžï¼‰ï¼Œ**

## ðŸ”’ 3. Next-Key é”ï¼ˆRecord + Gapï¼‰
- **å®šä¹‰**ï¼šè¡Œé” + é—´éš™é”ï¼Œé”ä½è®°å½•æœ¬èº«åŠå…¶å‰æ–¹é—´éš™ã€‚
- **è§¦å‘æ¡ä»¶**ï¼š
	- é»˜è®¤ä½¿ç”¨ REPEATABLE READ éš”ç¦»çº§åˆ«ã€‚

	- å¯¹ç´¢å¼•åˆ—è¿›è¡ŒèŒƒå›´æˆ–ç­‰å€¼æŸ¥è¯¢ã€‚

	- ä½¿ç”¨ SELECT ... FOR UPDATEã€UPDATEã€DELETEã€‚
- **ç¤ºä¾‹**ï¼š
```sql
SELECT * FROM users WHERE id > 5 AND id <= 10 FOR UPDATE;
DELETE FROM users WHERE id > 5 AND id <= 10;
```
- è¯´æ˜Žï¼šå‡è®¾id< 10çš„æœ€å‰é¢ä¸€ä¸ªæ•°æ˜¯5ä¼šé”ä½ id åœ¨ (5,10] ä¹‹é—´çš„èŒƒå›´ï¼Œå¦‚æžœid<10å¹¶ä¸å­˜åœ¨è®°å½•ï¼Œåˆ™é”ä½(-âˆž,10]
**ä¼šå‘å‰â€œæ‰©å±•â€åˆ°å‰ä¸€æ¡è®°å½•ï¼Œå¦‚æžœæ²¡æœ‰ï¼Œå°±é”åˆ°è´Ÿæ— ç©·ï¼ˆ-âˆžï¼‰ï¼Œ**


## ðŸ”’ 4. æ„å‘é”ï¼ˆIntention Lockï¼‰
- **å®šä¹‰**ï¼šè¡¨çº§é”ï¼Œè¡¨ç¤ºäº‹åŠ¡æ‰“ç®—å¯¹æŸäº›è¡ŒåŠ é”ã€‚ä»Žè€Œå®žçŽ°**è¡Œé”ä¸Žè¡¨é”çš„å…¼å®¹æ€§ç®¡ç†ã€‚**
- ç±»åž‹ï¼š
	- ISï¼ˆæ„å‘å…±äº«é”ï¼‰ï¼šè¡¨ç¤ºå°†å¯¹æŸäº›è¡ŒåŠ å…±äº«é”
	- IXï¼ˆæ„å‘æŽ’ä»–é”ï¼‰ï¼šè¡¨ç¤ºå°†å¯¹æŸäº›è¡ŒåŠ æŽ’ä»–é”
- **è§¦å‘æ¡ä»¶**ï¼š
	- åœ¨åŠ è¡Œé”å‰ï¼ŒInnoDB è‡ªåŠ¨æ·»åŠ æ„å‘é”
	
- **ç¤ºä¾‹**ï¼šIS
```sql
-- äº‹åŠ¡A
START TRANSACTION;
SELECT * FROM users WHERE id = 1 LOCK IN SHARE MODE;
```
- è¡Œçº§åŠ äº†ï¼šS é”ï¼ˆå…±äº«é”ï¼‰
- è¡¨çº§è‡ªåŠ¨åŠ ï¼šIS æ„å‘å…±äº«é”

- **ç¤ºä¾‹**ï¼šIX
```sql
-- äº‹åŠ¡B
START TRANSACTION;
SELECT * FROM users WHERE id = 1 FOR UPDATE;
```
- è¡Œçº§åŠ äº†ï¼šX é”ï¼ˆæŽ’ä»–é”ï¼‰
- è¡¨çº§è‡ªåŠ¨åŠ ï¼šIX æ„å‘æŽ’ä»–é”
### å¯å…¼å®¹æ€§
|    | IS | IX | S | X | LOCK TABLE WRITE |
| -- | -- | -- | - | - | ---------------- |
| IS | âœ”  | âœ”  | âœ” | âŒ | âŒ                |
| IX | âœ”  | âœ”  | âŒ | âŒ | âŒ                |
| S  | âœ”  | âŒ  | âœ” | âŒ | âŒ                |
| X  | âŒ  | âŒ  | âŒ | âŒ | âŒ                |


### ðŸ§  æ³¨æ„ç‚¹
- âœ… æ„å‘é”ä¸ä¼šé”ä½ä»»ä½•å…·ä½“æ•°æ®ï¼Œåªæ˜¯ä¸€ä¸ªâ€œæ ‡å¿—â€ã€‚
- âœ… å®ƒå‘Šè¯‰æ•°æ®åº“å¼•æ“Žï¼šâ€œæˆ‘åœ¨è¿™å¼ è¡¨çš„ä¸€éƒ¨åˆ†è®°å½•ä¸ŠåŠ äº†é”ï¼Œåˆ«æ¥åŠ æ•´å¼ è¡¨çš„é”ï¼â€
- âŒ ä½ ä¸èƒ½ç›´æŽ¥æŽ§åˆ¶æ„å‘é”ï¼Œå®ƒæ˜¯ InnoDB è‡ªåŠ¨åŠ çš„ã€‚

## ðŸ”’ 5. è¡¨é”ï¼ˆTable Lockï¼‰
- **å®šä¹‰**ï¼šæ˜¾å¼é”å®šæ•´å¼ è¡¨ï¼Œé˜»æ­¢å…¶ä»–äº‹åŠ¡è¯»å†™ã€‚
- **è§¦å‘æ¡ä»¶**ï¼š
	- ä½¿ç”¨ LOCK TABLES æ˜¾å¼åŠ é”
	
- **ç¤ºä¾‹**
```sql
LOCK TABLES
```

## ðŸ”’ 6.  å…ƒæ•°æ®é”ï¼ˆMDL - Metadata Lockï¼‰
- **å®šä¹‰**ï¼šä¿æŠ¤è¡¨ç»“æž„çš„é”ï¼Œé˜²æ­¢ DDL ä¸Ž DML å†²çªã€‚
- **è§¦å‘æ¡ä»¶**ï¼š
	- è®¿é—®è¡¨ï¼ˆSELECT/INSERT/UPDATE ç­‰ï¼‰æ—¶è‡ªåŠ¨åŠ é”
- **ç¤ºä¾‹**
```sql
-- ä¼šè¯1
BEGIN;
SELECT * FROM users WHERE id = 1;

-- ä¼šè¯2ï¼ˆé˜»å¡žï¼‰
ALTER TABLE users ADD COLUMN sex INT;
```
- **è¯´æ˜Žï¼š**åªè¦è¡¨åœ¨äº‹åŠ¡ä¸­æœªæäº¤ï¼Œå…¶ä»–çº¿ç¨‹ä¸èƒ½ä¿®æ”¹è¡¨ç»“æž„ã€‚

## æ•°æ®å¼•æ“Žå¯¹æ¯”

| é”ç±»åž‹                | æ˜¯å¦ InnoDB ä¸“å±ž   | æ˜¯å¦ MyISAM æœ‰     |
| ------------------ | -------------- | --------------- |
| âœ… è¡Œé”ï¼ˆRecord Lockï¼‰  | âœ”ï¸ ä»… InnoDB æ”¯æŒ | âŒï¼ˆMyISAM åªæœ‰è¡¨é”ï¼‰  |
| âœ… é—´éš™é”ï¼ˆGap Lockï¼‰    | âœ”ï¸ InnoDB ç‰¹æœ‰   | âŒ               |
| âœ… Next-Key é”       | âœ”ï¸ InnoDB ä¸“å±ž   | âŒ               |
| âœ… æ„å‘é”ï¼ˆIntent Lockï¼‰ | âœ”ï¸ InnoDB ä¸“å±ž   | âŒ               |
| âŒ è¡¨é”ï¼ˆLOCK TABLEï¼‰   | âœ… æ‰€æœ‰å­˜å‚¨å¼•æ“Žéƒ½æ”¯æŒ    | âœ”ï¸ MyISAM ä¸»è¦é”ç±»åž‹ |
