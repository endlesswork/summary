

## 🌳 ZooKeeper 数据模型

ZooKeeper 的数据结构类似于一个内存中的 **树形文件系统**，以 `/` 为根，每个节点称为一个 **znode**，支持类似路径的访问结构。

---

### 📂 znode 节点类型

每个 znode 可以存储数据和子节点，znode 分为以下几种类型：

| 类型              | 说明                                                                 |
|-------------------|----------------------------------------------------------------------|
| **持久节点**       | 节点创建后一直存在，直到被显式删除                                  |
| **临时节点**       | 节点在客户端会话断开时自动删除                                       |
| **顺序节点**       | ZooKeeper 自动在节点名称后追加一个自增编号                           |
| **持久顺序节点**   | 持久 + 顺序（常用于队列等场景）                                      |
| **临时顺序节点**   | 临时 + 顺序（常用于分布式锁、Leader 选举）                           |

---

### 🧾 znode 的特性

- **每个节点可存储少量数据**（约 1MB 限制）
- **支持 ACL 权限控制**（可设置读写权限）
- **支持 watch 机制**：客户端可对节点设置监听器，获取变化通知

## ⚙️ ZooKeeper 工作原理

ZooKeeper 是一个为分布式系统提供协调服务的中间件，它的核心目标是保证 **分布式系统中的数据一致性** 和 **节点协调能力**。

### 🧠 架构角色

ZooKeeper 集群中的每个服务器节点都扮演以下三种角色之一：

| 角色       | 描述 |
|------------|------|
| **Leader** | 负责处理所有写请求，并进行事务提议、广播与提交 |
| **Follower** | 接收客户端读请求，转发写请求，参与 Leader 选举 |
| **Observer** | 不参与写请求投票，仅作为只读节点扩展读取能力，提高系统吞吐量 |

---

### 🔄 工作流程概述

ZooKeeper 采用 **主从架构**，所有写请求必须通过 **Leader**，而读请求可以通过任意节点完成。

#### 📥 客户端与服务端交互流程：

1. 客户端连接集群中的任一节点（Leader 或 Follower）
2. 如果是读请求 → 节点直接处理
3. 如果是写请求 → 节点转发给 Leader → 发起 ZAB 协议流程
4. 写入操作在多数节点确认后完成 → 返回结果给客户端

---

### 🔁 写请求流程（使用 ZAB 协议）

1. Leader 接收到客户端写请求
2. Leader 向所有 Follower 发送 Proposal（提议）
3. 多数 Follower 回复 ACK
4. Leader 向所有节点发送 Commit 消息
5. 所有节点将数据写入内存 + 日志，并响应成功

---

##### 📖 读请求流程

- 客户端发送读请求到任意节点（Leader 或 Follower）
- 节点直接读取本地内存中的最新数据
- ZooKeeper 保证 **线性一致性**，所以读到的数据一定是最新的写入状态

---

### 🔄 节点状态同步

ZooKeeper 使用 **会话机制（Session）** 来追踪客户端连接状态。每个客户端连接是有状态的，支持：

- 监听器 Watch 设置
- 会话超时
- 临时节点绑定（会话断开后自动删除）

---

### 🗳 Leader 选举机制

当 Leader 节点挂掉后，会触发新一轮选举流程：

- 每个节点向其他节点发起投票
- 每个投票包含节点的 `myid` 和最新事务 ID（ZXID）
- 多数派投票选出拥有最大 ZXID 的节点为新 Leader
- 新 Leader 同步数据后集群恢复服务

---

### 📊 数据一致性保证

ZooKeeper 的一致性由以下几个特性支撑：

| 特性             | 描述 |
|------------------|------|
| 顺序一致性       | 所有写操作按顺序执行（ZAB 保证） |
| 原子性           | 操作不可分割 |
| 单一视图         | 所有客户端都看到同一个数据状态 |
| 会话机制         | 临时节点与客户端会话绑定 |
| 可靠性           | 写入后即使节点挂掉也不会丢失数据（写入日志 + 快照） |



